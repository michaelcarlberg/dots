#-------------------------------------------------------------------------------
# Tmux configuration
#-------------------------------------------------------------------------------

# set -g default-shell "/bin/bash"
# set -g default-command "exec bash -l"
# set -g default-terminal "tmux-256color"

set -sg terminal-overrides ",*:RGB"

set -g update-environment "DISPLAY TERM SSH_AUTH_SOCK SSH_CONNECTION GNUPGHOME GPG_TTY DBUS_SESSION_BUS_ADDRESS ALACRITTY_WINDOW_ID FZF_DEFAULT_OPTS"

# General {{{

set -g prefix M-a
set -g prefix2 C-b

# Double-tap alt-a to send prefix to nested tmux session
bind M-a send-prefix

set -g base-index 1
set-window-option -g pane-base-index 1

set -g visual-activity off
set -g visual-bell off
set -g visual-silence off

set -g set-titles on
set -g set-titles-string "Terminal: #W / tmux=#S"
set-window-option -g automatic-rename on

set -g display-time 1500
set -g history-limit 10000
set -g status-keys vi
set -g mouse on
set-window-option -g mode-keys vi
set-window-option -g monitor-activity off
set-window-option -g monitor-silence 0

# No delay for escape key press
set -sg escape-time 0

# Don't trigger prefix key on paste
set -g assume-paste-time 1

set -g focus-events on

# }}}
# Hooks {{{

# set-hook window-layout-changed 'run-shell ~/.config/tmux/scripts/emacs-status-toggle.sh'

# }}}
# Keybindings {{{

bind -n M-f resize-pane -Z

bind-key v split-window -hc '#{pane_current_path}'
bind-key s split-window -vc '#{pane_current_path}'
bind-key M-v split-window -hc '#{pane_current_path}'
bind-key M-s split-window -vc '#{pane_current_path}'

bind-key j select-pane -D
bind-key k select-pane -U
bind-key h select-pane -L
bind-key l select-pane -R

bind-key -n M-j select-pane -D
bind-key -n M-k select-pane -U
bind-key -n M-h select-pane -L
bind-key -n M-l select-pane -R

bind-key -n M-J resize-pane -D 5
bind-key -n M-K resize-pane -U 5
bind-key -n M-H resize-pane -L 5
bind-key -n M-L resize-pane -R 5

bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-0 select-window -t 0

bind -n M-] next-window
bind -n M-[ previous-window
bind -n M-d kill-pane

bind M-x run-shell "TMUX_FZF_MENU='1\necho item:1\n\n\n2\necho item:2\n' ~/.config/tmux/plugins/tmux-fzf/scripts/menu.sh"

bind R rotate

bind -T prefix C-v paste-buffer

bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "xclip -in -selection clipboard"

bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded"

bind-key -n M-= select-layout tiled

# }}}
# Theme {{{

set -g status on
set -g status-interval 1
set -g status-justify left

set -g status-left ' #[fg=colour07]#{client_user} #[fg=colour8]at#[fg=colour01] #H #[fg=colour8]~ #[default]'
set -g status-left-length 0

set -g status-right '#[fg=white,dim]#(~/.config/tmux/scripts/kbd.sh)#[default] #(~/.config/tmux/scripts/battery.sh)#[default] #[fg=white,dim]%Y-%m-%d %H:%M#[default]'
set -g status-right-length 0

setw -g mode-style 'fg=brightyellow,bg=black,reverse'

set -g window-style bg=default
set -g window-active-style bg=default

set -g status-style bg=default,fg=colour09
set -g message-style bg=default,fg=colour08

set -g pane-border-style fg=colour19
set -g pane-active-border-style fg=colour08

set -g display-panes-active-colour colour09
set -g display-panes-colour colour08

setw -g window-status-current-style fg=colour63,bg=default
setw -g window-status-style fg=colour08,bg=default

set -g window-status-activity-style bg=colour09,fg=black
set -g window-status-bell-style bg=colour09,fg=black

# vt fixes
if-shell '[ ! "${TERM##*256color*}${TERM##*24bit*}" ]' {
    set -g status-style fg=yellow,bg=black,bright
    set -g message-style bg=black,fg=yellow

    set -g pane-border-style fg=brightblack
    set -g pane-active-border-style fg=white

    set -g display-panes-active-colour black
    set -g display-panes-colour green

    set-window-option -g window-status-style fg=brightblack,bg=default
    set-window-option -g window-status-current-style fg=black,bg=green,none
}

# }}}

# Configure plugins
# -- https://github.com/tmux-plugins/list

setenv -g TMUX_PLUGIN_MANAGER_PATH '~/.config/tmux/plugins'

set -g @plugin 'tmux-plugins/tpm'

# -- plugin: tmux-autoreload {{{

# set -g @tmux-autoreload-configs '~/.config/tmux/tmux.conf'
# set -g @plugin 'b0o/tmux-autoreload'

# }}}
# -- plugin: tmux-fzf {{{

bind-key 'L' run-shell -b '~/.config/tmux/plugins/tmux-fzf/scripts/session.sh'
bind-key 'K' run-shell -b '~/.config/tmux/plugins/tmux-fzf/scripts/keybinding.sh'
bind-key 'M' run-shell -b '~/.config/tmux/plugins/tmux-fzf/scripts/menu.sh'
bind-key 'W' run-shell -b '~/.config/tmux/plugins/tmux-fzf/scripts/window.sh'
bind-key 'P' run-shell -b '~/.config/tmux/plugins/tmux-fzf/scripts/pane.sh'
bind-key 'S' run-shell -b '~/.config/tmux/plugins/tmux-fzf/scripts/process.sh'

setenv -g TMUX_FZF_OPTIONS "-d -w 100% -h 35% -y 100 \
  --no-preview --no-border \
  --color='bg:-1,bg+:-1' \
  --color='fg:bright-black,fg+:white' \
  --color='hl+:bright-red:reverse' \
  --color='hl:red' \
  --color='border:19,gutter:red:-1' \
  --color='header:red,info:red' \
  --color='label:bright-white' \
  --color='scrollbar:bright-black' \
  --color='preview-label:red' \
  --color='preview-border:bright-black' \
  --color='marker:red' \
  --color='pointer:bright-red:bold' \
  --color='prompt:bright-red:bold' \
  --color='separator:red:bold' \
  --color='query:bright-white:regular' \
  --color='spinner:red'"
# setenv -g TMUX_FZF_MENU \
# "default-foo\necho 'Hello!'\n"\
# "default-bar\nls ~\n"\
# "default-sh\nsh ~/test.sh\n"

set -g @plugin 'sainnhe/tmux-fzf'

# }}}
# -- plugin: tmux-nvim-navigation {{{

set -g @plugin 'aserowy/tmux.nvim'

# navigation
set -g @tmux-nvim-navigation true
set -g @tmux-nvim-navigation-cycle false
set -g @tmux-nvim-navigation-keybinding-left 'M-h'
set -g @tmux-nvim-navigation-keybinding-down 'M-j'
set -g @tmux-nvim-navigation-keybinding-up 'M-k'
set -g @tmux-nvim-navigation-keybinding-right 'M-l'

# resize
set -g @tmux-nvim-resize true
set -g @tmux-nvim-resize-step-x 5
set -g @tmux-nvim-resize-step-y 5
set -g @tmux-nvim-resize-keybinding-up 'M-K'
set -g @tmux-nvim-resize-keybinding-down 'M-J'
set -g @tmux-nvim-resize-keybinding-left 'M-H'
set -g @tmux-nvim-resize-keybinding-right 'M-L'

# }}}
# -- plugin: tmux-yank {{{

set -g @plugin 'tmux-plugins/tmux-yank'

# }}}
# -- plugin: tmux-fzf-url {{{

# set -g @plugin 'wfxr/tmux-fzf-url'

# set -g @fzf-url-bind 'u'
# set -g @fzf-url-extra-filter "~/.config/tmux/scripts/fzf-query.sh"
# set -g @fzf-url-open "~/.config/tmux/scripts/fzf-query.sh"

bind-key o run-shell -b '~/.config/tmux/scripts/fzf-links.sh'
bind-key u run-shell -b '~/.config/tmux/scripts/fzf-links.sh'

# }}}

run '~/.config/tmux/plugins/tpm/tpm'

# vim:ft=tmux
